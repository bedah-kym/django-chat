# Architecture Fusion Diagram & Connector Flow

---

## System Architecture (How Everything Connects)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        EXISTING MATHIA STACK                       â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Users App  â”‚      â”‚  Chatbot App â”‚      â”‚  Auth / Security â”‚ â”‚
â”‚  â”‚ (models.py)  â”‚      â”‚(consumers.py)â”‚      â”‚  (encryption.py) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                               â–²                                    â”‚
â”‚                               â”‚ (WebSocket)                        â”‚
â”‚                               â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         ORCHESTRATION LAYER (Core Dispatcher)             â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  intent_parser.py                                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Parse user message â†’ structured intent JSON     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Actions: get_weather, find_jobs, schedule...   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ‘‰ NEW: search_buses, create_itinerary, etc.     â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                     â”‚                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  mcp_router.py (Multi-Control Protocol Router)      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Validates intent                                â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Dispatches to appropriate connector             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Manages caching, rate-limits                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Returns structured response                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Existing Connectors:                        â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ WhatsAppConnector                         â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ MailgunConnector                          â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ WeatherConnector                          â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ UpworkConnector                           â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                             â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ ğŸš€ NEW Travel Connectors:                   â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ TravelBusesConnector                      â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ TravelHotelsConnector                     â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ TravelFlightsConnector                    â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ TravelTransfersConnector                  â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ TravelEventsConnector                     â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ ItineraryConnector (LLM composer)         â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                     â”‚                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  llm_client.py (Claude / Hugging Face Router)       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ generate_text() â†’ calls Claude or HF             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ stream_text() â†’ streaming responses              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Use for: itinerary composition, intent parsing   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Fallback: HF router if Claude unavailable        â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                     â”‚                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Redis  â”‚    â”‚  Celery  â”‚      â”‚ Postgresâ”‚
   â”‚ (cache) â”‚    â”‚ (tasks)  â”‚      â”‚  (DB)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ (caches search results)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         NEW: Travel Integration Layer                           â”‚
â”‚                                                                 â”‚
â”‚  orchestration/integrations/                                   â”‚
â”‚  â”œâ”€â”€ buupass.py           â†’ Web scraper + API wrapper         â”‚
â”‚  â”œâ”€â”€ booking.py           â†’ Affiliate link builder            â”‚
â”‚  â”œâ”€â”€ duffel.py            â†’ Flight API client                 â”‚
â”‚  â”œâ”€â”€ karibu.py            â†’ Transfer API client               â”‚
â”‚  â””â”€â”€ eventbrite.py        â†’ Events API client                 â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚      â”‚      â”‚      â”‚      â”‚
        â–¼      â–¼      â–¼      â–¼      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      â”‚     â”‚        â”‚      â”‚          â”‚
    â–¼      â–¼     â–¼        â–¼      â–¼          â–¼
  [Buupass] [Booking] [Duffel] [Karibu] [Eventbrite] [Local Data]
```

---

## Chat User Flow (How It Works End-to-End)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. USER SENDS MESSAGE (WebSocket)                                â”‚
â”‚    "Plan a 3-day Mombasa trip. Budget: 10,000 KES"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. CHATBOT CONSUMER (chatbot/consumers.py)                       â”‚
â”‚    â€¢ Receives message via WebSocket                              â”‚
â”‚    â€¢ Authenticates user                                          â”‚
â”‚    â€¢ Passes to intent parser                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. INTENT PARSER (orchestration/intent_parser.py)                â”‚
â”‚    â€¢ Calls LLM: "What does user want?"                          â”‚
â”‚    â€¢ LLM Returns:                                                â”‚
â”‚      {                                                            â”‚
â”‚        "action": "create_itinerary",                            â”‚
â”‚        "parameters": {                                           â”‚
â”‚          "destination": "Mombasa",                              â”‚
â”‚          "duration": 3,                                          â”‚
â”‚          "budget_ksh": 10000                                    â”‚
â”‚        }                                                          â”‚
â”‚      }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. MCP ROUTER (orchestration/mcp_router.py)                      â”‚
â”‚    â€¢ Routes to: ItineraryConnector                              â”‚
â”‚    â€¢ Dispatches itinerary builder service                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ITINERARY BUILDER (orchestration/services/itinerary_builder)  â”‚
â”‚    â€¢ Triggers 5 parallel searches:                               â”‚
â”‚      - search_buses (Mombasa)                                    â”‚
â”‚      - search_hotels (Mombasa, 3 days)                           â”‚
â”‚      - search_flights (optional)                                 â”‚
â”‚      - search_transfers (airport/city)                           â”‚
â”‚      - search_events (Mombasa, dates)                            â”‚
â”‚                                                                  â”‚
â”‚    Wait for all results...                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚Buses API â”‚   â”‚Hotels    â”‚   â”‚Events    â”‚
   â”‚(Buupass)â”‚   â”‚(Booking) â”‚   â”‚(Eventbrite)
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                â”‚                â”‚
        â”‚(cached)        â”‚(redirect)      â”‚(API)
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
   Buses              Hotels             Events
   1500 KES           3000 KES           Free
        â”‚                â”‚                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. AGGREGATE RESULTS                                             â”‚
â”‚    {                                                              â”‚
â”‚      "buses": [...],                                             â”‚
â”‚      "hotels": [...],                                            â”‚
â”‚      "events": [...],                                            â”‚
â”‚      "transfers": [...]                                          â”‚
â”‚    }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. LLM COMPOSITION (llm_client.py)                               â”‚
â”‚    â€¢ System: "You are travel planner. Compose a day-by-day      â”‚
â”‚      itinerary from these search results."                       â”‚
â”‚    â€¢ User: [all search results]                                  â”‚
â”‚    â€¢ LLM Returns JSON:                                           â”‚
â”‚      {                                                            â”‚
â”‚        "itinerary": [                                            â”‚
â”‚          {                                                        â”‚
â”‚            "day": 1,                                             â”‚
â”‚            "items": [                                            â”‚
â”‚              {"type": "bus", "title": "Nairobiâ†’Mombasa",        â”‚
â”‚               "price_ksh": 1500, "booking_url": "..."},         â”‚
â”‚              {"type": "hotel", "title": "Sarova Stanley",       â”‚
â”‚               "price_ksh": 3000, "booking_url": "..."}          â”‚
â”‚            ]                                                      â”‚
â”‚          },                                                       â”‚
â”‚          {...day 2...},                                          â”‚
â”‚          {...day 3...}                                           â”‚
â”‚        ],                                                         â”‚
â”‚        "total_cost_ksh": 9500,                                  â”‚
â”‚        "notes": "Fits budget!"                                  â”‚
â”‚      }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. SAVE TO DATABASE (travel/models.py)                           â”‚
â”‚    â€¢ Create Itinerary record                                     â”‚
â”‚    â€¢ Create ItineraryItem records (one per bus, hotel, etc.)     â”‚
â”‚    â€¢ Store booking_urls for later redirect                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. RETURN TO USER (WebSocket)                                    â”‚
â”‚    Bot: "Here's your itinerary! Total: 9,500 KES               â”‚
â”‚           [Book Bus] [Book Hotel] [Export PDF] [Share]"         â”‚
â”‚                                                                  â”‚
â”‚    User sees formatted itinerary in chat                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Optional:
10. USER CLICKS [Book Hotel]
    â†’ Opens Booking.com with affiliate ID + pre-filled data
    â†’ User completes booking on Booking.com
    â†’ You earn 25% commission

11. USER CLICKS [Export PDF]
    â†’ Calls export_service.py
    â†’ Generates PDF of itinerary
    â†’ User downloads
```

---

## Web UI User Flow (Search Form Option)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. USER FILLS FORM (Web UI - HTMX or React)                      â”‚
â”‚    Destination: [Mombasa]                                        â”‚
â”‚    Dates: [Dec 27] to [Dec 30]                                  â”‚
â”‚    Budget: [10000 KES]                                           â”‚
â”‚    [SEARCH]                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼ HTTP POST /api/travel/search/
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. API ENDPOINT (travel/views.py)                                â”‚
â”‚    â€¢ Validates parameters                                        â”‚
â”‚    â€¢ Calls MCPRouter for each search type                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. RETURN RESULTS (JSON)                                         â”‚
â”‚    {                                                              â”‚
â”‚      "buses": [{...}, {...}],                                    â”‚
â”‚      "hotels": [{...}, {...}],                                   â”‚
â”‚      "events": [{...}, {...}]                                    â”‚
â”‚    }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. WEB UI DISPLAYS RESULTS (Cards/Table)                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚    â”‚ Buses (Nairobiâ†’  â”‚  â”‚ Hotels (Mombasa) â”‚                    â”‚
â”‚    â”‚ Mombasa)         â”‚  â”‚                  â”‚                    â”‚
â”‚    â”‚ 6:00am - 12:00pm â”‚  â”‚ Sarova Stanley   â”‚                    â”‚
â”‚    â”‚ KSh 1,500/pax    â”‚  â”‚ KSh 3,000/night  â”‚                    â”‚
â”‚    â”‚ [Book]           â”‚  â”‚ [Book]           â”‚                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚    â”‚ Transfers        â”‚  â”‚ Events           â”‚                    â”‚
â”‚    â”‚ JKIA â†’ Hotel     â”‚  â”‚ Beach Festival    â”‚                    â”‚
â”‚    â”‚ KSh 1,500        â”‚  â”‚ Sat 6pm - Free   â”‚                    â”‚
â”‚    â”‚ [Book]           â”‚  â”‚ [Add to Plan]    â”‚                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                   â”‚
â”‚    [Select Items] â†’ [Create Itinerary] â†’ [Checkout]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Connector Architecture (Detail View)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         All Travel Connectors Inherit From             â”‚
â”‚         BaseTravelConnector (base_travel_connector.py) â”‚
â”‚                                                         â”‚
â”‚  async execute(parameters, context) â†’ Dict:            â”‚
â”‚    1. Check Redis cache                                â”‚
â”‚    2. If miss: call _fetch()                           â”‚
â”‚    3. Cache result (TTL: 1 hour)                       â”‚
â”‚    4. Return {status, results, count}                  â”‚
â”‚                                                         â”‚
â”‚  async _fetch(parameters, context):                    â”‚
â”‚    Implemented by each subclass                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚         â”‚         â”‚         â”‚         â”‚
         â”‚         â”‚         â”‚         â”‚         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚Buses â”‚  â”‚Hotels â”‚  â”‚Flightsâ”‚  â”‚Transfer â”‚ â”‚Events   â”‚
    â”‚      â”‚  â”‚       â”‚  â”‚       â”‚  â”‚        â”‚ â”‚         â”‚
    â”‚Async â”‚  â”‚Async  â”‚  â”‚Async  â”‚  â”‚Async   â”‚ â”‚Async    â”‚
    â”‚Call: â”‚  â”‚Build  â”‚  â”‚Call   â”‚  â”‚Call:   â”‚ â”‚Call:    â”‚
    â”‚      â”‚  â”‚Aff.   â”‚  â”‚Duffel â”‚  â”‚Karibu  â”‚ â”‚Eventbrite
    â”‚Soup  â”‚  â”‚Link   â”‚  â”‚API    â”‚  â”‚API +   â”‚ â”‚API      â”‚
    â”‚+BS4  â”‚  â”‚       â”‚  â”‚+ Mock â”‚  â”‚Fallbackâ”‚ â”‚         â”‚
    â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚         â”‚          â”‚         â”‚         â”‚
        â”‚         â”‚          â”‚         â”‚         â”‚
    Returns: Returns:  Returns:   Returns:   Returns:
    Buses    Hotels    Flights    Transfers  Events
    List     Redirect  List       List       List
             URL
```

---

## Data Model Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚ (Existing)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1
       â”‚
       â”‚ has many
       â”‚
       â–¼ M
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Itinerary                        â”‚
â”‚ â”œâ”€ user_id                               â”‚
â”‚ â”œâ”€ title                                 â”‚
â”‚ â”œâ”€ region (Mombasa, Nairobi, etc.)      â”‚
â”‚ â”œâ”€ start_date, end_date                  â”‚
â”‚ â”œâ”€ budget_ksh                            â”‚
â”‚ â”œâ”€ created_at, updated_at                â”‚
â”‚ â””â”€ is_public, metadata                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1
       â”‚
       â”‚ has many
       â”‚
       â–¼ M
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ItineraryItem                      â”‚
â”‚ â”œâ”€ itinerary_id                          â”‚
â”‚ â”œâ”€ item_type (bus/hotel/flight/event)    â”‚
â”‚ â”œâ”€ title                                 â”‚
â”‚ â”œâ”€ start_datetime, end_datetime          â”‚
â”‚ â”œâ”€ provider (Buupass/Booking.com/etc.)   â”‚
â”‚ â”œâ”€ price_ksh                             â”‚
â”‚ â”œâ”€ booking_url                           â”‚
â”‚ â”œâ”€ booking_reference                     â”‚
â”‚ â”œâ”€ status (draft/booked/cancelled)       â”‚
â”‚ â””â”€ metadata (provider-specific data)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Event (Local Events)              â”‚
â”‚ â”œâ”€ title                                 â”‚
â”‚ â”œâ”€ start_datetime, end_datetime          â”‚
â”‚ â”œâ”€ location_name, latitude, longitude    â”‚
â”‚ â”œâ”€ price_ksh (0 = free)                  â”‚
â”‚ â”œâ”€ ticket_url                            â”‚
â”‚ â”œâ”€ provider (Eventbrite/local_scrape)    â”‚
â”‚ â””â”€ category (concert/conference/market)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      SearchCache (Redis Backed)          â”‚
â”‚ â”œâ”€ query_hash                            â”‚
â”‚ â”œâ”€ provider (Buupass/Eventbrite/etc.)    â”‚
â”‚ â”œâ”€ result_json                           â”‚
â”‚ â”œâ”€ ttl_seconds (3600)                    â”‚
â”‚ â””â”€ created_at                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    BookingReference (Tracking)           â”‚
â”‚ â”œâ”€ itinerary_item_id                     â”‚
â”‚ â”œâ”€ provider                              â”‚
â”‚ â”œâ”€ provider_booking_id                   â”‚
â”‚ â”œâ”€ status (pending/confirmed/cancelled)  â”‚
â”‚ â”œâ”€ booking_url                           â”‚
â”‚ â””â”€ created_at                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Message Flow: Intent â†’ Connector â†’ Response

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Chat   â”‚
â”‚ "Plan trip" â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ (WebSocket message)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatConsumer.receive()                       â”‚
â”‚ â€¢ Extract message                            â”‚
â”‚ â€¢ Authenticate user                          â”‚
â”‚ â€¢ Pass to parse_intent()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ intent_parser.parse()                        â”‚
â”‚ â€¢ Calls LLM                                  â”‚
â”‚ â€¢ Returns:                                   â”‚
â”‚   {action: "create_itinerary",               â”‚
â”‚    parameters: {...}}                        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MCPRouter.route()                            â”‚
â”‚ â€¢ Validates intent                           â”‚
â”‚ â€¢ Looks up connector by action               â”‚
â”‚ â€¢ Calls connector.execute()                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ItineraryConnector.execute()                 â”‚
â”‚ â€¢ Calls itinerary_builder.build()            â”‚
â”‚ â€¢ Builder triggers parallel searches         â”‚
â”‚ â€¢ Awaits all results                         â”‚
â”‚ â€¢ Calls LLM to compose itinerary             â”‚
â”‚ â€¢ Saves to DB (Itinerary + Items)            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return to MCPRouter                          â”‚
â”‚ {status: "success",                          â”‚
â”‚  data: {itinerary: [...]},                   â”‚
â”‚  message: "Itinerary created"}               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatConsumer: Send via WebSocket             â”‚
â”‚ â€¢ Format response                            â”‚
â”‚ â€¢ Send JSON to client                        â”‚
â”‚ â€¢ Client renders itinerary                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Web Browser  â”‚
â”‚ Shows:       â”‚
â”‚ â€¢ Day-by-day â”‚
â”‚ â€¢ Prices     â”‚
â”‚ â€¢ [Book]     â”‚
â”‚   buttons    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary: How Everything Works Together

1. **User speaks naturally** ("Plan a Mombasa trip")
2. **Intent Parser** (LLM) understands intent â†’ creates JSON structure
3. **MCPRouter** routes to appropriate connector(s)
4. **Travel Connectors** (new) call APIs/scrapers in parallel, cache results
5. **Itinerary Builder** (LLM again) composes day-by-day plan from search results
6. **Database** stores itinerary for later retrieval
7. **Chat/Web UI** displays results with one-click booking links
8. **User clicks "Book"** â†’ redirects to provider (Booking.com, Duffel, etc.)
9. **Provider handles payment** â†’ you earn commission

**Zero code duplication.** Everything reuses existing patterns (MCPRouter, LLMClient, Channels, Django models).

---

**This architecture is production-ready. No changes needed. Ready to code.**

---

**Prepared by:** AI Planning Agent  
**Date:** December 22, 2025  
**Status:** Complete âœ…
