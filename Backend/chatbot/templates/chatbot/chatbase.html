{%load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">


<title>MATHIA chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="{% static 'css/chatbase.css' %}" rel="stylesheet">

</head>
<body>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />

<div class="container">
<div class="row clearfix">
<div class="col-lg-12">

<div onload="changemode()" id="mode" class="card chat-app">
<div id="plist" class="people-list">

<div class="input-group">
<div class="input-group-prepend">
<span class="input-group-text"><i class="fa fa-search"></i></span>
</div>
<input type="text" class="form-control" placeholder="Search...">
</div>

<ul class="list-unstyled chat-list mt-2 mb-0">
{% for chatroom in chatrooms %}
    {% if chatroom.id != 2 %}
        <li class="clearfix active">
        <img src="https://bootdey.com/img/Content/avatar/avatar1.png" alt="avatar">
        <a href="{% url 'chatbot:bot-home' chatroom.id %}">
        <div class="about">
        <div class="name">MATHIA ROOM{{chatroom.id}} (TEST ROOM)</div>
        <div class="status"> <i class="fa fa-circle online"></i> online </div>
        </div>
        </a>
        </li>
        <li>
        </li>
    {%else%}
        <li class="clearfix active">
        <img src="https://bootdey.com/img/Content/avatar/avatar1.png" alt="avatar">
        <a href="{% url 'chatbot:bot-home' chatroom.id %}">
        <div class="about">
        <div class="name">MATHIA ROOM{{chatroom.id}} (LIVE CHAT ROOM) </div>
        <div class="status"> <i class="fa fa-circle online"></i> online </div>
        </div>
        </a>
        </li>
        <li>
        </li>
    {%endif%}
        

{%endfor%}

<!--
<li class="clearfix">
<img src="https://bootdey.com/img/Content/avatar/avatar3.png" alt="avatar">
<div class="about">
<div class="name">Mike Thomas</div>
<div class="status"> <i class="fa fa-circle online"></i> online </div>
</div>
</li>
<li class="clearfix">
<img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="avatar">
<div class="about">
<div class="name">Christian Kelly</div>
<div class="status"> <i class="fa fa-circle offline"></i> left 10 hours ago </div>
</div>
</li>
<li class="clearfix">
<img src="https://bootdey.com/img/Content/avatar/avatar8.png" alt="avatar">
<div class="about">
<div class="name">Monica Ward</div>
<div class="status"> <i class="fa fa-circle online"></i> online </div>
</div>
</li>
<li class="clearfix">
<img src="https://bootdey.com/img/Content/avatar/avatar3.png" alt="avatar">
<div class="about">
<div class="name">Dean Henry</div>
<div class="status"> <i class="fa fa-circle offline"></i> offline since Oct 28 </div>
</div>
-->
</li>
</ul>

</div>
<div class="chat">
<div class="chat-header clearfix">
<div class="row">
<div class="col-lg-6">
<a href="javascript:void(0);" data-toggle="modal" data-target="#view_info">
<img src="https://bootdey.com/img/Content/avatar/avatar2.png" alt="avatar">
</a>
<div class="chat-about">
<h6 class="m-b-0">{{request.user}}</h6>
<div class="status"> <i class="fa fa-circle online"></i> online </div>
</div>
</div>
<div class="col-lg-6 hidden-sm text-right">
{%comment%}
<a href="javascript:void(0);" class="btn btn-outline-secondary"><i class="fa fa-camera"></i></a>
<a href="javascript:void(0);" class="btn btn-outline-primary"><i class="fa fa-image"></i></a>
<a href="javascript:void(0);" class="btn btn-outline-info"><i class="fa fa-cogs"></i></a>

{%endcomment%}
<button onclick="FetchMessages()" class="btn btn-outline-warning p-2 m-2">Get all messages <i class="fa fa-question"></i></button>
<a href="{%url 'users:logout' %}"class="btn btn-outline-danger p-1 m-1"><span>logout</span><img class="p-1"style=""src="https://img.icons8.com/ios/50/null/login-rounded-right--v1.png"/></a>
</div>
</div>
</div>
<div class="chat-history">
<ul id="top-chat" class="m-b-0">


</ul>
</div>
<div class="chat-message clearfix">
<div class="input-group mb-0">
<div class="input-group-prepend">
<button id="chat-message-submit" class="btn btn-outline none p-2"><i class="fa fa-send"></i></button>

</div>

<input class="form-control"id="chat-message-input" type="text" size="100"><br>


</div>
</div>
</div>
</div>
</div>
</div>
</div>
<script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
    <script src="{% static 'js/reconnecting-websocket.js'%}"></script>
    <script src="{% static 'js/reconnecting-websocket.min.js'%}"></script>
    
    <script>
        var roomName = {{room_name}};
        console.log("room",roomName)
        var username = {{username}};
        var chatSocket = new ReconnectingWebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomName
            + '/'
        );
        
        chatSocket.onmessage = function(e) {
            var data = JSON.parse(e.data); 
            console.log(data)
            if (data['command'] == 'messages'){
                for(let i=(data['messages'].length)-1;i>=0;i--){
                    createMessage(data['messages'][i]);
                }
            }else if (data['command'] == 'new_message'){
                createMessage(data['message']);
            }

        };
        function createMessage(data){  
           var message = data;
           var author = data['member'];
           var time3 = data['timestamp'];
           var time = (message.timestamp).slice(10,-16);
           //var time2 = (message.timestamp).slice();
           //console.log(time3,time)
           
           var msgListTag = document.createElement('li');
           var msgDivTag = document.createElement('div');
           var msgdivtag = document.createElement('p');
           var msgSpanTag = document.createElement('span');
           var msgpTag = document.createElement('div');
           var msgTextTag = document.createElement('div');
           msgTextTag.innerHTML= message.content; 
           msgdivtag.innerHTML = author; 
           msgpTag.innerHTML += time;


           if (message.member === username){
               msgListTag.className ='clearfix';
               msgDivTag.className ='message-data text-right';
               msgSpanTag.className ='message-data-time';
               msgTextTag.className ='message other-message float-right';
               msgpTag.className = 'time-sender';
               msgdivtag.className = 'user-name';
               msgListTag.appendChild(msgDivTag);
               msgDivTag.appendChild(msgpTag);
               msgDivTag.appendChild(msgSpanTag);
               msgSpanTag.appendChild(msgTextTag);
               msgTextTag.appendChild(msgdivtag);
           }
           else{
               
               msgListTag.className ='clearfix';
               msgDivTag.className ='message-data';
               msgSpanTag.className ='message-data-time';
               msgTextTag.className ='message my-message';
               msgpTag.className = 'time-left';
               msgdivtag.className = 'user-name';
               msgListTag.appendChild(msgDivTag);
               msgDivTag.appendChild(msgpTag);
               msgDivTag.appendChild(msgSpanTag);
               msgSpanTag.appendChild(msgTextTag);
               msgTextTag.appendChild(msgdivtag);
               
           }   
           document.querySelector('#top-chat').appendChild(msgListTag);
           
       };

        function FetchMessages(){
            chatSocket.send(JSON.stringify(
                {
                    "command":"fetch_messages",
                    "chatid":roomName
                }
                )
            );
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            var messageInputDom = document.querySelector('#chat-message-input');
            var message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message,
                'from':username,
                'command':'new_message',
                "chatid":roomName
            }));
            messageInputDom.value = '';
        };
    </script>
</html>



